# 规则依赖图可视化系统 - 使用说明

## 快速开始

### 启动应用

```bash
cd frontend
npm install  # 首次运行需要安装依赖
npm run dev  # 启动开发服务器
```

然后在浏览器中打开 http://localhost:5173/

## 界面说明

### 1. 顶部：Query选择表格
显示所有可用的query及其统计信息，点击任意行选择要分析的query。

**表格列说明**：
- **Query**: 查询语句
- **#Nodes**: 规则节点数量
- **#Edges**: 规则依赖边数量  
- **#Candidates**: 候选实体数量
- **GT Rank**: Ground Truth的排名位置

### 2. 左侧：规则依赖图面板

#### 过滤面板（顶部）
通过三个滑块过滤规则节点：
- **Surprisal**: 规则的惊讶度范围
- **Support**: 规则的支持度范围
- **Body Size**: 规则体大小范围

调整滑块后，图会实时更新，只显示符合条件的节点和边。

#### 依赖图（下方）
使用Cola.js力导向布局自动排列规则节点：

**节点视觉编码**：
- 大小：映射到Support（支持度越高，圆越大）
- 颜色：映射到Surprisal（蓝色=低，红色=高）
- 高亮：点击Candidate后，相关节点会高亮显示

**边视觉编码**：
- 箭头方向：表示规则依赖方向
- 高亮：点击Candidate后，相关边会变为红色

**交互**：
- 鼠标悬停：显示节点或边的详细信息
- 自动布局：图会自动调整节点位置避免重叠

### 3. 右侧：Candidate分析面板

#### 二部图（左侧）
展示Rules和Candidates之间的关系：
- 左列：所有规则节点（标记为R0, R1, ...）
- 右列：所有候选实体节点
- 连线：表示该Candidate包含哪些规则

**视觉标记**：
- 绿色圆圈：Ground Truth (GT)
- 橙色圆圈：其他候选
- 红色边框：当前选中的Candidate

**交互**：点击Candidate节点，左侧依赖图会高亮显示该Candidate的规则子图。

#### Candidate信息表格（右侧）
详细列出每个Candidate的指标：

**表格列**：
- **Name**: Candidate名称
- **GT**: 是否为Ground Truth（✓/✗）
- **Orig.**: Original Surprisal
- **Base**: Base Surprisal  
- **New**: New Surprisal
- **Rank**: rankBefore → rankAfter

**交互**：
- 点击行选中Candidate，左侧依赖图高亮对应子图
- 再次点击取消选中
- GT行有绿色背景标记

## 使用流程

1. **选择Query**
   - 在顶部表格中浏览可用的query
   - 点击某一行加载该query的数据

2. **探索整体依赖图**
   - 观察规则之间的依赖关系
   - 使用过滤器聚焦于特定指标范围的规则
   - 悬停查看规则详情

3. **分析Candidate**
   - 在右侧二部图中观察Candidate和规则的对应关系
   - 点击Candidate查看其规则子图
   - 对比不同Candidate的指标差异

4. **发现洞察**
   - 比较GT和其他Candidate的规则组成
   - 分析rank变化大的Candidate
   - 识别关键规则节点（被多个Candidate共享）

## 数据格式说明

数据文件：`out/example.json`（每行一个query对象）

```json
{
  "query": "head_entity relation ?",
  "nodes": [
    ["rule_string", bodySize, support, surprisal],
    ...
  ],
  "edges": [
    [sourceNodeIdx, targetNodeIdx, bodySize, support, surprisal],
    ...
  ],
  "candidates": [
    {
      "name": "entity_id",
      "nodes": [0, 1, 2],      // 包含的规则索引
      "edges": [0, 1],          // 包含的边索引
      "GT": true/false,         // 是否为Ground Truth
      "originalSurprisal": 1.5,
      "baseSurprisal": 1.2,
      "newSurprisal": 2.0,
      "rankBefore": 5,          // 原始排名
      "rankAfter": 3            // 新排名
    }
  ]
}
```

## 技术说明

- **前端框架**: Svelte 5 - 轻量级响应式框架
- **图布局**: WebCola - 约束力导向布局算法
- **可视化**: D3.js - 数据驱动的图形绘制
- **构建工具**: Vite - 快速的开发服务器

## 常见问题

**Q: 为什么有些节点没有显示？**  
A: 可能被过滤器过滤掉了，尝试调整过滤器范围。

**Q: 如何取消Candidate选择？**  
A: 再次点击已选中的Candidate行或节点。

**Q: 图布局看起来很乱怎么办？**  
A: 使用过滤器减少节点数量，或等待布局算法收敛（几秒钟）。

**Q: 如何找到Ground Truth？**  
A: 在右侧表格中查找带✓标记的行，或在二部图中找绿色圆圈。

## 项目文件结构

```
RuleDepDemo/
├── data/
│   └── example.json         # 数据文件（每行一个query）
├── frontend/
│   ├── src/
│   │   ├── components/      # Svelte组件
│   │   ├── lib/             # 工具函数
│   │   ├── App.svelte       # 主应用
│   │   └── main.js          # 入口
│   ├── public/
│   │   └── data/
│   │       └── example.json # 软链接到数据文件
│   └── package.json
└── 使用说明.md              # 本文档
```

## 联系与反馈

如有问题或建议，请通过项目issue提交。
